---
// src/components/Scene3D.astro
---

<div id="canvas-container"></div>

<script>
  import * as THREE from 'three';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';

  gsap.registerPlugin(ScrollTrigger);

  // --- 1. ESCENA ---
  const container = document.getElementById('canvas-container');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
  camera.position.set(0, 2, 8); // C谩mara cerca

  const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  container.appendChild(renderer.domElement);

  // --- 2. LUCES ---
  const ambientLight = new THREE.AmbientLight(0xffffff, 2); 
  scene.add(ambientLight);
  const dirLight = new THREE.DirectionalLight(0xffffff, 3);
  dirLight.position.set(5, 10, 7);
  scene.add(dirLight);

  // --- VARIABLES DE ANIMACIN ---
  let mixer: THREE.AnimationMixer;
  const clock = new THREE.Clock();

  // --- 3. CARGAR PERSONAJE ---
  const loader = new GLTFLoader();
  let model: any;

  //  NOTA LA RUTA: Entramos a la carpeta 'personaje'
  loader.load('/scene.gltf', (gltf: any) => {
    
    model = gltf.scene;

    // === ACTIVAR ANIMACIN ===
    if (gltf.animations && gltf.animations.length > 0) {
        mixer = new THREE.AnimationMixer(model);
        // Reproducimos la primera animaci贸n que encuentre (ej: Idle, Run, Walk)
        const action = mixer.clipAction(gltf.animations[0]);
        action.play();
        console.log("Reproduciendo animaci贸n:", gltf.animations[0].name);
    } else {
        console.warn("No se encontraron animaciones en este archivo.");
    }

    // === AJUSTES VISUALES ===
    // Auto-escala
    const box = new THREE.Box3().setFromObject(model);
    const size = box.getSize(new THREE.Vector3());
    const maxAxis = Math.max(size.x, size.y, size.z);
    model.scale.set(5/maxAxis, 5/maxAxis, 5/maxAxis); // Tama帽o 5 unidades
    
    // Auto-centrado
    const center = box.getCenter(new THREE.Vector3());
    model.position.x += (model.position.x - center.x);
    model.position.y = -2.5; // Bajamos un poco los pies
    model.position.z += (model.position.z - center.z);

    scene.add(model);

    // --- MOVIMIENTO CON SCROLL (OPCIONAL) ---
    // Hacemos que el personaje gire un poco al bajar
    gsap.to(model.rotation, {
      y: Math.PI * 0.5, 
      scrollTrigger: {
        trigger: "body",
        start: "top top",
        end: "bottom bottom",
        scrub: 1, 
      }
    });
    
    // Animaci贸n de entrada
    gsap.from(model.scale, { x:0, y:0, z:0, duration: 1, ease: "back.out" });

  }, undefined, (error) => { console.error('ERROR:', error); });

  // --- 4. LOOP ---
  function animate() {
    requestAnimationFrame(animate);
    
    // Actualizar animaci贸n interna (si existe)
    const delta = clock.getDelta();
    if (mixer) mixer.update(delta);

    renderer.render(scene, camera);
  }
  animate();

  // Resize
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

<style>
  #canvas-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: -1;
    pointer-events: none;
  }
</style>