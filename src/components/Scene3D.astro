---
// src/components/Scene3D.astro
---

<div id="canvas-container"></div>

<script>
  import * as THREE from 'three';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  // 1. Registrar el plugin de Scroll
  gsap.registerPlugin(ScrollTrigger);

  // 2. Configuración de la Escena
  const container = document.getElementById('canvas-container');
  const scene = new THREE.Scene();
  
  // CÁMARA
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
  camera.position.z = 5;

  // RENDERER (¡Aquí está el truco del fondo transparente!)
  const renderer = new THREE.WebGLRenderer({ 
    alpha: true, // <--- ESTO QUITA EL FONDO
    antialias: true // <--- SUAVIZA LOS BORDES
  });
  
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Optimización para móviles
  container.appendChild(renderer.domElement);

  // 3. El Objeto (Un Cubo por ahora)
  // Si tienes un modelo GLTF, aquí es donde usarías GLTFLoader
  const geometry = new THREE.BoxGeometry(2, 2, 2);
  const material = new THREE.MeshNormalMaterial(); // Material colorido para pruebas
  const mesh = new THREE.Mesh(geometry, material);
  scene.add(mesh);

  // 4. La Animación con GSAP (La Magia)
  gsap.to(mesh.rotation, {
    y: Math.PI * 2, // Girar 360 grados (2 * PI)
    x: Math.PI * 0.5, // Girar un poco en vertical
    scrollTrigger: {
      trigger: "body", // ¿Qué dispara el scroll? (Toda la página)
      start: "top top", // Empieza cuando el top del body toca el top de la ventana
      end: "bottom bottom", // Termina cuando llegas al final
      scrub: 1, // <--- IMPORTANTE: El "1" hace que tarde 1s en alcanzar tu dedo (suavidad)
    }
  });

  // 5. Loop de Renderizado
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  // 6. Responsividad (Si cambian el tamaño de la ventana)
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

<style>
  #canvas-container {
    position: fixed; /* Se queda fijo mientras scrolleas */
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: -1; /* Se va al fondo, detrás del texto */
    pointer-events: none; /* Deja que puedas seleccionar el texto de encima */
  }
</style>