---
// src/components/Scene3D.astro
---

<div id="canvas-container"></div>

<script>
  import * as THREE from 'three';
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';
  // IMPORTANTE: Usamos GLTFLoader
  import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';

  gsap.registerPlugin(ScrollTrigger);

  // --- 1. CONFIGURACIÃ“N DE LA ESCENA ---
  const container = document.getElementById('canvas-container');
  const scene = new THREE.Scene();
  
  // CÃ¡mara
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
  camera.position.set(0, 2, 12); 

  const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  container.appendChild(renderer.domElement);

  // --- 2. ILUMINACIÃ“N ---
  const ambientLight = new THREE.AmbientLight(0xffffff, 2); 
  scene.add(ambientLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 3);
  dirLight.position.set(5, 10, 7);
  scene.add(dirLight);

  // --- 3. CARGAR EL MODELO GLTF/GLB ---
  const loader = new GLTFLoader();
  let model: any;

  // ðŸ‘‡ CAMBIA '/scene.gltf' POR EL NOMBRE DE TU ARCHIVO
  loader.load('/scene.gltf', (gltf: any) => {
    
    // CORRECCIÃ“N DEL ERROR:
    // En archivos GLTF, el modelo estÃ¡ dentro de la propiedad .scene
    model = gltf.scene; 

    // === AUTO-AJUSTE: CENTRAR Y ESCALAR ===
    const box = new THREE.Box3().setFromObject(model);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());

    // Centrar
    model.position.x += (model.position.x - center.x);
    model.position.y += (model.position.y - center.y);
    model.position.z += (model.position.z - center.z);

    // Escalar (Ajustamos para que mida 6 unidades de alto)
    const maxAxis = Math.max(size.x, size.y, size.z);
    const targetSize = 6; 
    const scaleFactor = targetSize / maxAxis;
    
    model.scale.set(scaleFactor, scaleFactor, scaleFactor);
    model.position.y = -2; 

    scene.add(model);

    console.log("GLTF cargado correctamente. Escala:", scaleFactor);

    // --- ANIMACIÃ“N CON SCROLL (GSAP) ---
    gsap.to(model.rotation, {
      y: Math.PI * 2, 
      scrollTrigger: {
        trigger: "body",
        start: "top top",
        end: "bottom bottom",
        scrub: 1, 
      }
    });
    
    // AnimaciÃ³n de entrada
    gsap.from(model.scale, { x:0, y:0, z:0, duration: 1.5, ease: "elastic.out(1, 0.5)" });

  }, 
  // Progreso
  (xhr) => { console.log((xhr.loaded / xhr.total * 100) + '% cargado'); },
  // Errores
  (error) => { console.error('ERROR AL CARGAR GLTF:', error); }
  );

  // --- 4. LOOP DE ANIMACIÃ“N ---
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  // --- 5. REDIMENSIONAR ---
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>

<style>
  #canvas-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: -1;
    pointer-events: none;
  }
</style>